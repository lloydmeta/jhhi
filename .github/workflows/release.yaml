# Taken from https://raw.githubusercontent.com/zackify/flydb/master/.github/workflows/build-binary.yml

name: Build Binaries
on:
  push:

jobs:
  build:
     name: Build and maybe release
     strategy:
       matrix:
         include:
           - os: macos-10.15
             target: x86_64-apple-darwin
           - os: ubuntu-18.04
             target: x86_64-unknown-linux-musl
         runs-on: ${{ matrix.os }}
     steps:
       - uses: actions/checkout@master

       - name: Install musl-tools
         if: contains(matrix.target, 'musl')
         run: sudo apt-get install musl-tools

       - uses: actions-rs/toolchain@v1
         with:
           toolchain: stable
           target: ${{ matrix.target }}
           override: true

       - uses: actions-rs/cargo@v1
         with:
           command: build
           args: --release --target ${{ matrix.target }}

       - name: Tar the binary
         run: tar -czvf jhhi-${{ matrix.target }}.tar.gz target/${{ matrix.target }}/release/jhhi

       - name: Upload to release
         uses: softprops/action-gh-release@v1
         if: startsWith(github.ref, 'refs/tags/')
         env:
           GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
         with:
           files: jhhi-${{ matrix.target }}.tar.gz
